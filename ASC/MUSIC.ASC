5 rem ----------------------------------------------------
6 rem          Music Editor, By Francois Lionet
7 rem              Part of the Stos basic
8 rem             (c) Jawx / Mandarin 1988
9 rem -------------------15/8/1988------------------------
10 key off : if mode=0 then mode 1
15 if mode=1 then palette $300,$666,$0,$554 : C1=1 : C2=2 : C3=3 else C1=1 : C2=1 : C3=1
20 dim T$(100),TNOTE(2,1000),ADN(1000),TENV(50,8,2),WENV(50),BENV(8,2),NN(2),DEBN(2),PAGE(2),CN(2),V(3),NTET(7),NTED(12),NTEL(10),NTEP(10),OCTY(7),NTEY(12)
25 BANKMAX=32768 : SPEED=50 : XGR=32 : YGR=136/divy : TGR=6/divy
30 if free<BANKMAX+$8000 then bell : default : print "Not enough memory!"
99 rem---> Initialise menus
100 restore 50000+language*100
105 for X=1 to 5 : read A$ : menu$ (X)=A$,0,C3 : next X
110 paper 1 : pen 0 : for X=1 to 5 : read N : for Y=1 to N : read A$,Z : menu$ (X,Y)=A$ : if Z=0 then menu$ (X,Y) off 
115 next Y : next X
120 if accnb=0 then menu$ (1,4) off 
125 paper 0 : pen C3 : menu on 1 : menu freeze 
130 on menu goto 5000,6000,7000,8000,9000
199 rem---> Initialise text
200 restore 51000+language*100
205 X=0 : repeat : read T$(X) : inc X : until T$(X-1)=""
299 rem---> default screen
300 reset zone : paper 0 : pen C3 : curs off 
301 locate 0,1 : square 22,3,1 : locate 11-len(T$(36))/2,1 : print T$(36);
302 locate 0,4 : square 22,3,1 : locate 11-len(T$(37))/2,4 : print T$(37);
303 locate 0,7 : square 22,3,1 : locate 11-len(T$(38))/2,7 : print T$(38); : pen C1
305 windopen 1,0,11,26,14,1 : curs off : title T$(39)+str$(1)+" " : set zone 10,xgraphic(0),ygraphic(0) to xgraphic(23)+8,ygraphic(11)+16/divy
310 windopen 2,27,11,26,14,1 : curs off : title T$(39)+str$(2)+" " : set zone 11,xgraphic(0),ygraphic(0) to xgraphic(23)+8,ygraphic(11)+16/divy
315 windopen 3,54,11,26,14,1 : curs off : title T$(39)+str$(3)+" " : set zone 12,xgraphic(0),ygraphic(0) to xgraphic(23)+8,ygraphic(11)+16/divy
320 XSTAVE=184 : XST16=(XSTAVE/16)*16 : YSTAVE=144/divy : DST=4/divy : ink 1 : CRS=0
325 gosub 20000
399 rem---> Reserves memory banks
400 erase 3 : reserve as data 3,BANKMAX
405 gosub 10100
410 VBLOC=-1 : DBLOC=-1 : FBLOC=-1
415 for VOIX=0 to 2 : NN(VOIX)=0 : PAGE(VOIX)=0 : CN(VOIX)=0 : qwindow VOIX+1 : inverse off : pen C1 : clw : X=0 : CNOTE=12 : gosub 10500 : next VOIX : VOIX=0 : X=0 : gosub 10000 : gosub 10400
420 reserve as work 2,100 : erase 2
499 rem---> Read default enveloppes
500 gosub 9310
599 rem---> Read stave datas
600 restore 55000
605 for X=0 to 7 : read NTET(X) : next X
610 for X=0 to 11 : read NTED(X) : next X
615 for X=0 to 9 : read NTEL(X) : next X
620 for X=0 to 9 : read NTEP(X) : next X
625 for X=0 to 7 : read OCTY(X) : next X
630 for X=0 to 11 : read NTEY(X) : next X
900 CNOTE=12 : VBLOC=-1 : DBLOC=-1 : FBLOC=-1
905 if accnb=0 then 1000
910 B=1 : if length(B,3)=0 or leek(start(B,3))<>$13490157 then 1000
915 gosub 20100 : windopen 5,20,8,40,5,5 : curs off : inverse on : clw : print : centre T$(47) : wait 50
920 windel 5 : gosub 20150 : LBANK=(leek(start(B,3)+4+128)) : if LBANK>BANKMAX then gosub 10100 : goto 1000
925 copy start(B,3),start(B,3)+LBANK to start(3)
999 rem---> Main loop
1000 if VBLOC<0 or DBLOC<0 or FBLOC<0 then menu$ (4,3) off : menu$ (4,5) off : menu$ (4,6) off : menu$ (4,8) off else menu$ (4,3) on : menu$ (4,5) on : menu$ (4,6) on : menu$ (4,8) on 
1005 menu on 
1010 qwindow 0 : if VBLOC<0 then locate 1,5 : print space$(20); : goto 1020
1015 A$=" "+T$(43)+str$(VBLOC+1)+T$(44)+str$(DBLOC+1)+T$(45)+str$(FBLOC+1)+" " : locate 11-len(A$)/2,5 : print A$;
1020 if NOM$<>"" then locate 1,2 : print space$(20) : A$="- "+NOM$+" -" : locate 11-len(A$)/2,2 : print A$
1025 if CN(VOIX)<NN(VOIX) then gosub 10400
1030 qwindow 0 : locate 1,8 : print space$(20); : if LABEL=0 then A$=T$(CNOTE)+"    "+str$(COCT)+" "+T$(13+CLONG) : goto 1045
1035 A$=T$(23+LABEL) : if LABEL<7 then 1045
1036 P=PARAM1 : if LABEL=9 or LABEL=11 then P=P-25
1040 A$=A$+str$(P) : if LABEL=12 then A$=A$+","+str$(PARAM2)
1045 locate 11-len(A$)/2,8 : print A$;
1050 qwindow VOIX+1 : X=CN(VOIX) : CRS=1 : gosub 10500 : curs on : S$="" : clear key : on menu on 
1055 A$=inkey$ : S=scancode
1060 if mouse key then Z=zone(0) : if Z>9 then menu freeze : gosub 10050 : goto 2000
1065 if A$="" then 1055
1070 if asc(A$)=0 or asc(A$)=127 then gosub 10050 : goto 1500
1075 if asc(A$)=13 then gosub 10050 : goto 1200
1080 if asc(A$)=8 then if S$<>"" then S$=left$(S$,len(S$)-1) : cleft : print " "; : cleft : goto 1055
1085 A$=upper$(A$) : if asc(A$)<32 then 1055
1090 if len(S$)=15 then 1055
1095 S$=S$+A$ : print A$; : goto 1055
1199 rem--->Analyse line
1200 if NOM$="" then gosub 11500 : X=windon : qwindow 0 : locate 1,2 : print space$(20); : A$="- "+NOM$+" -" : locate 11-len(A$)/2,2 : print A$; : qwindow X
1205 if S$="" and LABEL<>0 then 1340
1210 for X=0 to 12 : if instr(S$,T$(23+X))<>0 then 1295
1215 next X
1220 LABEL=0 : for X=9 to 0 step-1 : if instr(S$,T$(13+X))<>0 then 1230
1225 next X : goto 1235
1230 CLONG=X : S$=S$-T$(13+X)
1235 for X=12 to 0 step-1 : if instr(S$,T$(X))<>0 then 1245
1240 next X : goto 1250
1245 CNOTE=X : S$=S$-T$(X)
1250 for X=0 to 7 : if instr(S$,chr$(48+X))<>0 then 1260
1255 next X : goto 1265
1260 COCT=X : if CNOTE=12 then COCT=0
1265 if CNOTE<>12 then TNOTE(VOIX,CN(VOIX))=CLONG*256+COCT*12+CNOTE+1 else TNOTE(VOIX,CN(VOIX))=CLONG*256 : COCT=0
1270 X=CN(VOIX) : inc CN(VOIX) : inc NN(VOIX) : gosub 10500 : if CN(VOIX)<NN(VOIX) then dec NN(VOIX) : goto 1280
1275 TNOTE(VOIX,CN(VOIX))=0 : if NN(VOIX)=998 then dec CN(VOIX) : dec NN(VOIX) : bell : goto 1025
1280 cdown : if CN(VOIX)-PAGE(VOIX)>11 then inc PAGE(VOIX) : gosub 20500
1285 goto 1025
1290 rem---> Analyse labels
1295 LABEL=X : S$=S$-T$(23+X)
1300 PARAM1=0 : PARAM2=0 : if LABEL<>0 then 1304
1301 NN(VOIX)=CN(VOIX) : TNOTE(VOIX,NN(VOIX))=0 : if VBLOC=VOIX then VBLOC=-1 : DBLOC=-1 : FBLOC=-1
1302 gosub 10300 : gosub 10400 : goto 1010
1304 if LABEL<8 and LABEL<>4 then 1340
1305 PARAM1=val(S$) : if PARAM1<0 then 1350
1310 if LABEL=4 then if PARAM1>31 then 1350
1315 if LABEL=8 then if PARAM1>15 then 1350
1320 if LABEL>=9 and LABEL<=11 then if PARAM1>24 or PARAM1=0 then 1350
1325 if LABEL=9 or LABEL=11 then if PARAM1<25 then PARAM1=PARAM1+25
1330 if LABEL>=9 and LABEL<=11 then if TENV(PARAM1-1,0,0)=0 or TENV(PARAM1-1,0,0)>100 then 1350
1335 if LABEL=12 then X=instr(S$,",") : if X=0 then 1350 else PARAM2=val(mid$(S$,X+1)) : if PARAM2<1 or PARAM2-1>=998 or PARAM1>255 then 1350 else 1340
1340 TNOTE(VOIX,CN(VOIX))=-(PARAM2*$10000+PARAM1*$100+LABEL)
1345 goto 1270
1350 wait 5 : bell : LABEL=0 : goto 1025
1499 rem---> Function keys
1500 menu freeze 
1505 if S=80 then gosub 1550
1510 if S=72 then gosub 1600
1515 if S=77 then gosub 1650
1520 if S=75 then gosub 1700
1525 if S=82 then gosub 1750
1530 if S=83 then gosub 1800
1535 on S-58 gosub 1850,1860,1870,1880
1540 menu on : goto 1030
1549 rem---> Curdown
1550 if CN(VOIX)=NN(VOIX) then return 
1555 X=CN(VOIX) : inc CN(VOIX) : gosub 10500
1560 if CN(VOIX)-PAGE(VOIX)<12 then 1570
1565 inverse off : inc PAGE(VOIX) : cdown : gosub 20500
1570 gosub 10400 : return 
1599 rem---> Curup
1600 if CN(VOIX)=0 then return 
1605 X=CN(VOIX) : dec CN(VOIX) : gosub 10500
1610 if CN(VOIX)-PAGE(VOIX)>=0 then 1620
1615 inverse off : dec PAGE(VOIX) : cup : gosub 20600
1620 gosub 10400 : return 
1649 rem---> Cur right
1650 X=CN(VOIX) : inc CN(VOIX) : gosub 10500 : dec CN(VOIX)
1655 X=VOIX+1 : if X=3 then X=0
1660 gosub 10000 : gosub 10350 : gosub 10400 : return 
1699 rem---> Cur left
1700 X=CN(VOIX) : inc CN(VOIX) : gosub 10500 : dec CN(VOIX)
1705 X=VOIX-1 : if X<0 then X=2
1710 gosub 10000 : gosub 10350 : gosub 10400 : return 
1749 rem---> Insert
1750 if CN(VOIX)=NN(VOIX) then return 
1755 if NN(VOIX)=998 then bell : return 
1760 for X=NN(VOIX) to CN(VOIX) step-1 : TNOTE(VOIX,X+1)=TNOTE(VOIX,X) : next X
1765 inc NN(VOIX)
1770 if VBLOC<0 or VBLOC<>VOIX then 1785
1775 if DBLOC>=CN(VOIX) then inc DBLOC
1780 if FBLOC>=CN(VOIX) then inc FBLOC
1785 gosub 10305 : gosub 10400 : pop : goto 1005
1799 rem---> Delete
1800 if CN(VOIX)=NN(VOIX) then return 
1805 for X=CN(VOIX) to NN(VOIX)-1 : TNOTE(VOIX,X)=TNOTE(VOIX,X+1) : next X
1810 dec NN(VOIX)
1815 if VBLOC<0 or VBLOC<>VOIX then 1830
1820 if DBLOC>CN(VOIX) then dec DBLOC
1825 if FBLOC>CN(VOIX) then dec FBLOC
1830 gosub 10300 : gosub 10400 : pop : goto 1005
1849 rem---> F1: Page up
1850 if PAGE(VOIX)=0 then return 
1852 if PAGE(VOIX)>11 then PAGE(VOIX)=PAGE(VOIX)-12 else PAGE(VOIX)=0
1855 CN(VOIX)=min(PAGE(VOIX)+11,NN(VOIX)) : gosub 10300 : gosub 10400 : return 
1859 rem---> Page down
1860 if NN(VOIX)-PAGE(VOIX)<12 then return 
1862 if PAGE(VOIX)+12>NN(VOIX) then PAGE(VOIX)=NN(VOIX)-12 else PAGE(VOIX)=PAGE(VOIX)+12
1865 CN(VOIX)=PAGE(VOIX) : gosub 10300 : gosub 10400 : return 
1869 rem---> Top
1870 if PAGE(VOIX)=0 then return else PAGE(VOIX)=0 : goto 1865
1879 rem---> Bottom
1880 if NN(VOIX)-PAGE(VOIX)<12 then return else PAGE(VOIX)=NN(VOIX)-11 : goto 1855
1999 rem---> Click into lines
2000 if Z-10<>VOIX then 2020
2005 YY=(y mouse-ygraphic(0))/(16/divy) : if YY<0 or YY>11 or PAGE(VOIX)+YY>NN(VOIX) then X=VOIX+1 : menu on : goto 1050
2010 X=CN(VOIX) : CN(VOIX)=PAGE(VOIX)+YY : gosub 10500
2015 gosub 10400 : menu on : goto 1025
2020 X=CN(VOIX) : inc CN(VOIX) : gosub 10500 : dec CN(VOIX)
2025 X=Z-10 : gosub 10000 : gosub 10350 : gosub 10400 : menu on : goto 1025
4999 rem---> STOS
5000 menu freeze : gosub 10050 : on mnselect gosub 5100,5005,5200,5300
5005 goto 1000
5099 rem---> About MUSIC!
5100 gosub 20100 : windopen 5,10,4,60,16,10 : curs off : set paint 2,13,0 : ink 1 : bar xgraphic(0),ygraphic(0) to xgraphic(57)+8,ygraphic(13)+16/divy
5105 locate 0,2 : centre T$(53) : locate 0,6 : centre T$(54) : locate 0,9 : centre T$(55) : locate 0,11 : centre T$(56)
5120 repeat : until mouse key
5125 windel 5 : gosub 20150 : return 
5199 rem---> Quit
5200 gosub 10600 : if R=0 then return 
5205 erase 3 : default : end 
5299 rem---> Quit and grab
5300 gosub 10600 : if R=0 then return 
5305 hide : curs off : wait 25 : copy start(3),start(3)+LBANK+4 to back
5310 erase 3 : reserve as data 3,LBANK+4 : copy back,back+LBANK+4 to start(3) : loke start(3)+4+128,LBANK : screen copy logic to back
5315 clear key : put key "BGRAB"+str$(accnb)+",3:ERASE"+str$(accnb)+",3`"
5320 default : end 
5999 rem---> Bank
6000 menu freeze : gosub 10050 : curs on : on mnselect gosub 6100,6175,6200,6005,6300,6005,6400
6005 on error goto 0
6010 goto 1000
6099 rem---> Load memory bank
6100 on error goto 6135
6105 paper 1 : pen 0 : gosub 20100 : R$=file select$("*.MBK",T$(86),2) : gosub 20150 : paper 0 : pen 1 : if R$="" or instr(R$,".MBK")=0 then bell : return 
6110 gosub 11700 : open in #1,R$ : X=lof(1) : close : if X>32768 then T=87 : goto 6140
6115 reserve as data 2,255 : bload R$,start(3)-18 : if leek(start(3))<>$13490157 then T=87 : goto 6140
6120 erase 2 : ADB=start(3)+4 : NOMFILE$=R$
6125 LBANK=leek(ADB+128)
6130 windel 5 : gosub 20150 : return 
6135 T=88 : resume 6140
6140 erase 2 : windel 5 : gosub 20150 : boom : gosub 11600 : return 
6174 rem---> Save memory bank
6175 if NOMFILE$="" then 6200 else R$=NOMFILE$ : goto 6205
6199 rem---> Save as
6200 paper 1 : pen 0 : gosub 20100 : R$=file select$("*.MBK",T$(89),2) : gosub 20150 : paper 0 : pen 1 : if R$="" or instr(R$,".MBK")=0 then bell : return 
6205 on error goto 6235
6210 hide : wait 25 : gosub 11700 : copy start(3),start(3)+LBANK+4 to back
6215 erase 3 : reserve as data 3,LBANK+4 : copy back,back+LBANK+4 to start(3) : loke start(3)+4+128,LBANK : save R$,3
6220 erase 3 : reserve as data 3,BANKMAX : QQ=LBANK : gosub 10100 : LBANK=QQ : copy back,back+LBANK+4 to start(3) : reserve as data 2,1 : erase 2
6225 screen copy logic to back : show 
6230 windel 5 : gosub 20150 : return 
6235 gosub 6220 : boom : T=88 : gosub 11600 : resume 6240
6240 return 
6299 rem---> Grab from program
6300 gosub 10600 : if R=0 then return 
6305 gosub 20100 : windopen 5,20,5,40,12,5 : inverse on : clw : print : centre T$(90) : print : print 
6310 Z=0 : for B=1 to 4 : if accnb=0 and B=current then 6330
6315 if length(B,3)=0 then 6330
6320 if leek(start(B,3))<>$13490157 then 6330
6325 bset B,Z : print " ";T$(91);B;T$(92);length(B,3)
6330 next B
6335 if Z=0 then windel 5 : gosub 20150 : T=93 : gosub 11600 : return 
6340 locate 0,8 : print " ";T$(94); : input B : if B<1 or B>4 or btst(B,Z)=0 then wait 5 : bell : windel 5 : gosub 20150 : return 
6345 windel 5 : gosub 20150 : LBANK=(leek(start(B,3)+4+128)) : if LBANK>BANKMAX then gosub 10100 : return 
6350 copy start(B,3),start(B,3)+LBANK to start(3) : return 
6399 rem---> Erase bank
6400 gosub 10600 : if R=0 then return 
6405 gosub 10100 : NOMFILE$=""
6410 return 
6999 rem---> Music
7000 menu freeze : gosub 10050 : on mnselect gosub 7100,7700,7005,7200,7400,7375,7600,7005,7800,7750,7005,7930
7005 on error goto 0
7010 goto 1000
7099 rem---> New music
7100 gosub 10600 : if R=0 then return 
7105 X=0 : gosub 10000 : for VOIX=0 to 2 : gosub 10200 : next VOIX : VOIX=2 : X=0 : gosub 10000 : SPEED=50
7110 gosub 11500
7115 return 
7199 rem---> Put music
7200 gosub 11300 : RR=R : if R=0 then return 
7201 gosub 11400 : if LB=0 then 7205
7202 for X=0 to 7 : if asc(mid$(NOM$,X+1,1))=peek(ADB+132+(R-1)*8+X) then next X : goto 7204
7203 gosub 10600 : if R=0 then RR=0 : return 
7204 R=RR : gosub 7610
7205 L=0 : for X=0 to 50 : WENV(X)=0 : next X
7210 for Y=0 to 2 : if NN(Y)=0 then 7245
7215 for X=0 to NN(Y)-1 : Z=TNOTE(Y,X) : L=L+2 : if Z>=0 then 7240
7220 A=-Z mod 256 : if A<9 then 7240
7225 B=(-Z/256) and 255 : L=L+2
7230 if A=12 then 7240
7235 if WENV(B-1)=0 then WENV(B-1)=1 : L=L+36
7240 next X : L=L+2
7245 next Y : if L=0 then bell : RR=0 : return 
7250 L=L+12 : if LBANK+L>BANKMAX then boom : gosub 20100 : windopen 5,20,8,40,7,12 : inverse on : clw : curs off : locate 0,1 : centre T$(73) : locate 0,3 : centre T$(74) : wait key : windel 5 : gosub 20150 : RR=0 : return 
7255 gosub 11700
7260 gosub 11400 : if R=32 then 7275
7265 copy AD,ADB+LBANK to AD+L : for X=R+1 to 32 : Y=leek(ADB+(X-1)*4) : if Y<>0 then loke ADB+(X-1)*4,Y+L
7270 next X
7275 LBANK=LBANK+L : loke ADB+(R-1)*4,AD-ADB+4
7280 for X=0 to 7 : poke ADB+132+(R-1)*8+X,asc(mid$(NOM$,X+1,1)) : next X
7285 loke AD,$19631969 : doke AD+4,SPEED : AP=AD+12 : for X=0 to 50 : if WENV(X)=0 then 7295
7290 WENV(X)=AP-AD : for Y=0 to 8 : poke AP,TENV(X,Y,0) : inc AP : poke AP,TENV(X,Y,2) : inc AP : doke AP,TENV(X,Y,1) : AP=AP+2 : next Y
7295 next X
7300 for Y=0 to 2 : doke AD+6+Y*2,0 : if NN(Y)=0 then 7355
7305 doke AD+6+Y*2,AP-AD : for X=0 to NN(Y)-1 : ADN(X)=AP : Z=TNOTE(Y,X) : if Z>=0 then doke AP,Z : goto 7330
7310 A=-Z mod 256 : B=(-Z/256) and 255
7315 if A<9 then doke AP,$A000 or ((A-1)*256) or B : goto 7330
7320 if A<12 then loke AP,$C0000000 or ((A-9)*$1000000) or WENV(B-1) : AP=AP+2 : goto 7330
7325 if A=12 then loke AP,$80008000 : AP=AP+2
7330 AP=AP+2 : next X : doke AP,$8000 : AP=AP+2 : for X=NN(Y) to 999 : ADN(X)=0 : next X
7335 for X=0 to NN(Y)-1 : if TNOTE(Y,X)>=0 then 7350
7340 Z=-TNOTE(Y,X) : A=Z mod 256 : if A<>12 then 7350
7345 B=(Z/256) and 255 : C=((Z/256)/256) and $FFFF : if C>0 then if ADN(C-1)<>0 then loke ADN(X),$C3000000 or B*$10000 or (ADN(C-1)-AD)
7350 next X
7355 next Y
7360 windel 5 : gosub 20150 : return 
7374 rem---> Append music
7375 if NOM$="" then gosub 11500
7380 gosub 11300 : if R=0 then return 
7385 gosub 11400 : if LB=0 then wait 5 : bell : return 
7390 for X=0 to 2 : DEBN(X)=NN(X) : next X : goto 7415
7399 rem---> Get music
7400 gosub 11300 : if R=0 then return 
7405 gosub 11400 : if LB=0 then wait 5 : bell : return 
7410 for X=0 to 2 : DEBN(X)=0 : next X : for Y=0 to 2 : NN(Y)=0 : CN(Y)=0 : PAGE(Y)=0 : next Y : NOM$="" : for X=0 to 7 : NOM$=NOM$+chr$(peek(ADB+132+(R-1)*8+X)) : next X
7415 gosub 11700
7420 for X=0 to 50 : if TENV(X,0,0)=0 or TENV(X,0,0)>100 then WENV(X)=0 else WENV(X)=-1
7425 next X : SPEED=deek(AD+4)
7430 for Y=0 to 2 : AP=deek(AD+6+Y*2) : if AP=0 then 7520
7435 for X=0 to DEBN(Y) : ADN(X)=-1 : next X : AP=AP+AD : for X=DEBN(Y) to 998 : ADN(X)=AP : A=deek(AP) : AP=AP+2 : if btst(15,A)=0 then TNOTE(Y,X)=A : goto 7480
7440 if A=$8000 then 7485
7445 if btst(13,A) then TNOTE(Y,X)=-((A mod 256)*256 or ((A/256 and $1F)+1)) : goto 7480
7450 B=deek(AP) : AP=AP+2 : A=A and $1FFF : if A/256=3 then TNOTE(Y,X)=-(B*$10000 or (A mod 256)*256 or 12) : goto 7480
7455 A=A/256 : AE=AD+B : for D=0 to 8 : BENV(D,0)=peek(AE) : inc AE : BENV(D,2)=peek(AE) : inc AE : C=deek(AE) : AE=AE+2 : if btst(15,C) then C=C or $FFFF0000
7460 BENV(D,1)=C : next D : if A=1 then ZZ=0 else ZZ=25
7465 for Z=ZZ to ZZ+24 : if WENV(Z)=0 then 7470
7467 for D=0 to 8 : for E=0 to 2 : if BENV(D,E)=TENV(Z,D,E) then next E : next D : TNOTE(Y,X)=-((Z+1)*256 or A+9) : goto 7480
7470 next Z : for Z=ZZ to ZZ+24 : if WENV(Z)<>0 then next Z : goto 7550
7475 for D=0 to 8 : for E=0 to 2 : TENV(Z,D,E)=BENV(D,E) : next E : next D : WENV(Z)=1 : TNOTE(Y,X)=-((Z+1)*256 or A+9)
7480 next X
7485 NN(Y)=X : if X=0 then 7520
7490 for X=NN(Y) to 999 : ADN(X)=$7FFFFFFF : next X
7495 for X=DEBN(Y) to NN(Y)-1 : if TNOTE(Y,X)>=0 then 7515
7500 Z=-TNOTE(Y,X) : A=Z mod 256 : if A<>12 then 7515
7505 B=((Z/256)/256) : C=match(ADN(0),B+AD) : if C<0 then C=0
7510 TNOTE(Y,X)=-((Z and $FFFF) or ((C+1)*$10000))
7515 next X
7520 next Y
7525 windel 5 : gosub 20150 : VBLOC=-1 : DBLOC=-1 : FBLOC=-1 : X=2 : gosub 10000 : CN(2)=-1 : PAGE(2)=DEBN(2) : gosub 10300 : CN(2)=PAGE(2) : X=1 : gosub 10000 : CN(1)=-1 : PAGE(1)=DEBN(1) : gosub 10300 : CN(1)=PAGE(1) : X=0 : gosub 10000 : CN(0)=-1 : PAGE(0)=DEBN(0) : gosub 10300 : CN(0)=DEBN(0) : return 
7549 rem---> Too many enveloppes or tremolos
7550 windel 5 : gosub 20150 : boom : gosub 20100 : windopen 5,10,6,60,10,3 : inverse on : clw 
7555 locate 0,1 : centre T$(75) : locate 0,3 : centre T$(76) : locate 0,4 : centre T$(77) : locate 0,6 : centre T$(74)
7560 clear key : wait key : windel 5 : gosub 20150
7565 gosub 20350 : X=0 : gosub 10000 : for Y=0 to 2 : NN(Y)=0 : PAGE(Y)=0 : CN(Y)=0 : qwindow Y+1 : inverse off : clw : X=0 : gosub 10500 : next Y : X=0 : gosub 10000 : gosub 10400
7570 NOM$="" : goto 1000
7599 rem---> Erase music
7600 gosub 11300 : OLDR=R : if R=0 then return 
7602 gosub 10600 : if R=0 then return 
7605 R=OLDR : gosub 11400 : if LB=0 then return 
7610 copy AF,ADB+LBANK to AD : LBANK=LBANK-LB
7615 loke ADB+(R-1)*4,0
7620 for X=R to 32 : Y=leek(ADB+(X-1)*4) : if Y<>0 then loke ADB+(X-1)*4,Y-LB
7625 next X
7630 for X=0 to 7 : poke ADB+132+(R-1)*8+X,32 : next X
7635 return 
7699 rem--> Rename music
7700 gosub 11500 : return 
7749 rem---> PUT AND PLAY
7750 gosub 7200 : if RR=0 then return 
7755 R=RR : goto 7805
7799 rem---> Play music
7800 R=1 : gosub 11300 : if R=0 then return 
7805 gosub 11400 : if LB=0 then wait 5 : bell : return 
7810 A$=T$(78) : for X=0 to 7 : A$=A$+chr$(peek(ADB+132+(R-1)*8+X)) : next X : A$=A$+" "
7815 gosub 20100 : windopen 5,2,3,76,7,8 : inverse on : clw : title A$ : curs off 
7820 locate 0,1 : centre T$(79) : locate 0,2 : centre T$(80) : locate 0,3 : centre T$(81)
7825 windopen 6,10,10,60,9,8 : inverse on : clw : curs off 
7830 for X=0 to 2 : locate 4+X*18,3 : square 15,3,5 : V(X+1)=0 : next X
7835 PA=0 : TRANS=0 : music R
7840 locate 0,1 : centre "     "+T$(82)+str$(SPEED)+" / "+T$(83)+str$(TRANS)+" / "+T$(84+PA)+"     "
7845 for X=1 to 3 : if pvoice(X)=V(X) then 7865
7850 V(X)=pvoice(X) : locate 6+(X-1)*18,4 : if V(X)=0 then print "            "; : goto 7865
7855 A=deek(AD+V(X)) : B=A mod 256 : if B<>0 then C=(B-1)/12 : B=(B-1) mod 12 else B=12 : C=0
7860 print using "~~~~ ";T$(B);C;"  "; using "~~~";T$(A/256+13);
7865 next X : K$=inkey$ : clear key 
7870 if K$=chr$(27) then music off : windel 5 : windel 6 : gosub 20150 : return 
7875 if K$="s" or K$="S" then music R : transpose TRANS : PA=0 : goto 7840
7880 if K$="+" then if SPEED<100 then inc SPEED : doke AD+4,SPEED : if PA=0 then tempo SPEED : goto 7840 else 7840
7885 if K$="-" then if SPEED>0 then dec SPEED : doke AD+4,SPEED : if PA=0 then tempo SPEED : goto 7840 else 7840
7890 if K$="/" then if TRANS>-95 then dec TRANS : transpose TRANS : goto 7840
7895 if K$="*" then if TRANS<95 then inc TRANS : transpose TRANS : goto 7840
7900 if PA=0 then if K$=" " then PA=1 : tempo 0 : goto 7840
7905 if PA=0 or K$="" then 7845
7910 if K$<>" " then PA=0 : tempo SPEED : goto 7840
7915 Y=0 : tempo 100 : for X=1 to 3 : Y=Y+pvoice(X) : if V(X)=pvoice(X) then next X : if Y<>0 then 7915
7920 tempo 0 : goto 7845
7929 --->print music 
7930 if NOM$="" then wait 5 : bell : return 
7931 VX=VOIX : on error goto 7995
7932 gosub 20100 : windopen 5,20,10,40,5,10 : curs off : inverse on : clw : locate 0,1 : centre T$(95) : clear key 
7933 lprint string$("*",78) : lprint "*";space$(76);"*" : lprint "*";space$(34);NOM$;space$(34);"*" : lprint "*";space$(76);"*" : lprint string$("*",78) : lprint 
7935 for X=0 to 998 : A$=space$(75) : ZZ=0 : for VOIX=0 to 2 : if X>=NN(VOIX) then 7970
7940 inc ZZ : gosub 10405 : B$=str$(X+1) : B$=space$(5-len(B$))+B$+" :" : if LABEL=0 then B$=B$+T$(CNOTE)+space$(5-len(T$(CNOTE)))+str$(COCT)+" "+T$(CLONG+13) : goto 7965
7945 B$=B$+T$(23+LABEL) : if LABEL<8 and LABEL<>4 then 7965
7950 P=PARAM1 : if LABEL=9 or LABEL=11 then P=P-25
7955 B$=B$+str$(P) : if LABEL<12 then 7965
7960 B$=B$+str$(PARAM2)
7965 mid$(A$,1+VOIX*25)=B$
7970 next VOIX : if ZZ=0 then 7980
7975 lprint A$ : if inkey$="" then next X
7980 windel 5 : gosub 20150
7985 VOIX=VX : return 
7995 windel 5 : gosub 20150 : boom : T=96 : gosub 11600 : resume 7985
7999 rem---> Block
8000 menu freeze : gosub 10050 : on mnselect gosub 8100,8200,8300,8005,8400,8500,8005,8600
8005 goto 1000
8099 rem---> Start block
8100 if VBLOC>=0 and VOIX<>VBLOC then VX=VOIX : VOIX=VBLOC : CN=CN(VOIX) : CN(VOIX)=-1 : VBLOC=-1 : DBLOC=-1 : FBLOC=-1 : qwindow VOIX+1 : gosub 10300 : CN(VOIX)=CN : VOIX=VX : qwindow VOIX+1
8102 if CN(VOIX)=NN(VOIX) then 8110
8105 DBLOC=CN(VOIX) : VBLOC=VOIX : if FBLOC<0 or FBLOC<DBLOC then FBLOC=NN(VOIX)-1
8110 gosub 10300 : gosub 10400 : return 
8199 rem---> End block
8200 if VBLOC>=0 and VOIX<>VBLOC then VX=VOIX : VOIX=VBLOC : CN=CN(VOIX) : CN(VOIX)=-1 : VBLOC=-1 : DBLOC=-1 : FBLOC=-1 : qwindow VOIX+1 : gosub 10300 : CN(VOIX)=CN :  : VOIX=VX : qwindow VOIX+1
8202 if CN(VOIX)=NN(VOIX) then 8110
8205 FBLOC=CN(VOIX) : VBLOC=VOIX : if DBLOC<0 or DBLOC>FBLOC then DBLOC=0
8210 goto 8110
8299 rem---> Erase block
8300 if VBLOC>=0 and VOIX<>VBLOC then VX=VOIX : VOIX=VBLOC : CN=CN(VOIX) : CN(VOIX)=-1 : VBLOC=-1 : DBLOC=-1 : FBLOC=-1 : qwindow VOIX+1 : gosub 10300 : CN(VOIX)=CN :  : VOIX=VX : qwindow VOIX+1 : gosub 10400 : return 
8305 VBLOC=-1 : DBLOC=-1 : FBLOC=-1 : goto 8110
8399 rem---> Copy block
8400 if VBLOC<0 or DBLOC<0 or FBLOC<0 then bell : return 
8405 if VOIX=VBLOC and (CN(VOIX)>=DBLOC and CN(VOIX)<=FBLOC) then bell : return 
8410 D=FBLOC-DBLOC+1 : if NN(VOIX)+D>998 then bell : return 
8415 for X=NN(VOIX) to CN(VOIX) step-1 : TNOTE(VOIX,X+D)=TNOTE(VOIX,X) : next X
8420 NN(VOIX)=NN(VOIX)+D : if VOIX=VBLOC and DBLOC>=CN(VOIX) then DBLOC=DBLOC+D : FBLOC=FBLOC+D
8425 for X=0 to D-1 : TNOTE(VOIX,CN(VOIX)+X)=TNOTE(VBLOC,DBLOC+X) : next X
8430 gosub 10300 : gosub 10400 : return 
8499 rem---> Delete bloc
8500 if VBLOC<0 or DBLOC<0 or FBLOC<0 then bell : return 
8505 if VOIX<>VBLOC then bell : return 
8510 D=FBLOC-DBLOC+1 : if CN(VOIX)>=FBLOC then CN(VOIX)=CN(VOIX)-D else if CN(VOIX)>DBLOC then CN(VOIX)=DBLOC
8515 for X=DBLOC to NN(VOIX)-D : TNOTE(VOIX,X)=TNOTE(VOIX,X+D) : next X
8520 NN(VOIX)=NN(VOIX)-D : PAGE(VOIX)=max(0,DBLOC-6) : CN(VOIX)=min(NN(VOIX),DBLOC)
8525 VBLOC=-1 : DBLOC=-1 : FBLOC=-1 : gosub 10300 : gosub 10400 : return 
8599 rem---> Transpose bloc
8600 rem
8605 if VBLOC<0 or DBLOC<0 or FBLOC<0 then bell : return 
8610 gosub 20100 : windopen 5,15,10,50,5 : scroll off : inverse on : clw 
8615 centre T$(51) : locate 0,2 : print T$(52); : clear key : input T : windel 5 : gosub 20150 : if T=0 or T<-12 or T>12 then bell : return 
8620 for X=DBLOC to FBLOC : Y=TNOTE(VBLOC,X) : if Y<0 or Y mod 256=0 then 8630
8625 Z=Y mod 256 : if Z+T>0 and Z+T<97 then TNOTE(VBLOC,X)=(Y and $FF00) or (Z+T)
8630 next X
8635 VX=VOIX : VOIX=VBLOC : CN=CN(VOIX) : CN(VOIX)=-1 : qwindow VOIX+1 : gosub 10300 : CN(VOIX)=CN :  : VOIX=VX : qwindow VOIX+1 : gosub 10400 : return 
8999 rem---> Tools
9000 menu freeze : gosub 10050 : on mnselect gosub 9100,9095,9300
9005 goto 1000
9094 rem---> Make tremolo
9095 CENV=DTREM : goto 9105
9099 rem---> Make enveloppe
9100 CENV=DENV
9105 gosub 20100 : windopen 5,0,0,80,25,4 : scroll off 
9110 locate 0,ytext(YGR) : print " 0"; : locate 0,ytext(YGR-8*TGR) : print " 8"; : locate 0,ytext(YGR-15*TGR) : print "15";
9115 locate xtext(XGR),ytext(YGR)+1 : print "0           1            2            3            4           5 "; : print T$(59);
9120 locate 9,9 : print T$(61)
9125 for YY=0 to 8 : locate 10,10+YY : print YY+1; : for XX=0 to 2 : locate 17+XX*20,10+YY : print "\"; : next XX : next YY
9130 for X=0 to 3 : locate 0,19+X : centre T$(64+X) : next X
9135 gosub 10700 : gosub 11200 : gosub 10800
9140 clear key : S$="" : inverse off : gosub 11100 : inverse on : locate 28+XX*20,10+YY : print "      "; : locate 28+XX*20,10+YY
9145 A$=inkey$ : S=scancode
9150 if A$="" then 9145
9155 A$=upper$(A$)
9160 if A$=chr$(27) then windel 5 : gosub 20150 : if CENV<25 then DENV=CENV : return else DTREM=CENV : return 
9165 if A$=" " then if CENV<25 then gosub 10900 : goto 9150 else gosub 11000 : goto 9150
9170 if A$=chr$(13) then 9220
9175 if A$=chr$(8) then if len(S$)>0 then cleft : print " "; : cleft : S$=left$(S$,len(S$)-1) : goto 9145 else 9145
9180 if A$<>chr$(0) then if len(S$)<6 then S$=S$+A$ : print A$; : goto 9145
9185 if S=72 then inverse off : gosub 11100 : if YY>0 then dec YY : goto 9140 else 9140
9190 if S=80 then inverse off : gosub 11100 : if YY<=8 and TENV(CENV,YY,0)<>0 and TENV(CENV,YY,0)<128 then inc YY : goto 9140 else 9140
9195 if S=75 then inverse off : gosub 11100 : dec XX : if XX>=0 then 9140 else XX=2 : goto 9140
9200 if S=77 then inverse off : gosub 11100 : inc XX : if XX<=2 then 9140 else XX=0 : goto 9140
9205 if S=59 then if CENV<>0 and CENV<>25 then dec CENV : goto 9135
9210 if S=60 then if CENV<>24 and CENV<>49 then inc CENV : goto 9135
9215 goto 9145
9220 A=val(S$) : if A=0 then if asc(S$)>=65 and asc(S$)<65+26 then 9255
9225 if XX=0 then if A<1 or A>100 then wait 5 : bell : goto 9140
9230 if XX=1 then if A<-16 or A>16 then wait 5 : bell : goto 9140
9235 if XX=2 then if A<0 or A>255 then wait 5 : bell : goto 9140
9240 if YY=8 then wait 5 : bell : goto 9140
9245 TENV(CENV,YY,XX)=A : inverse off : gosub 11100 : gosub 10800
9250 gosub 11200 : goto 9140
9255 if XX<>0 then wait 5 : bell : goto 9270
9260 if left$(S$,1)=mid$(T$(62),2,1) then A=128 : goto 9245
9265 if left$(S$,1)=mid$(T$(63),2,1) then A=129 : goto 9245
9270 wait 5 : bell : goto 9245
9299 rem---> Default enveloppes and tremolos
9300 gosub 10600 : if R=0 then return 
9305 for ZZ=0 to 24 : for YY=0 to 8 : for XX=0 to 2 : TENV(ZZ,YY,XX)=0 : next XX : next YY : next ZZ
9310 restore 52000 : for CENV=0 to 24 : for N=0 to 7 : read X,Y,Z : if X<0 then 9325
9315 TENV(CENV,N,0)=X : TENV(CENV,N,1)=Y : TENV(CENV,N,2)=Z : if X<101 then next N
9320 next CENV
9325 restore 53000
9330 for CENV=25 to 49 : for N=0 to 7 : read X,Y,Z : if X<0 then 9345
9335 TENV(CENV,N,0)=X : TENV(CENV,N,1)=Y : TENV(CENV,N,2)=Z : if X<101 then next N
9340 next CENV
9345 DENV=0 : DTREM=25 : return 
9999 rem---> Activate voice X
10000 qwindow VOIX+1 : inverse off : border 1 : title T$(39)+str$(VOIX+1)+" "
10005 VOIX=X : qwindow VOIX+1 : border 2 : inverse on : title T$(39)+str$(VOIX+1)+" "
10010 inverse off : locate 1,CN(VOIX)-PAGE(VOIX) : return 
10049 rem---> Stop cursors
10050 sprite off : curs off : CRS=0 : return 
10099 rem---> Erase bank
10100 fill start(3) to start(3)+length(3),0 : loke start(3),$13490157
10105 ADB=start(3)+4 : fill ADB+32*4 to ADB+132+32*8,$20202020
10110 LBANK=32*4+4+32*8
10115 return 
10199 rem---> Erases voice
10200 TNOTE(VOIX,0)=0 : NN(VOIX)=0 : PAGE(VOIX)=0 : CN(VOIX)=0
10205 if VBLOC=VOIX then VBLOC=-1 : DBLOC=-1 : FBLOC=-1
10210 gosub 10300 : gosub 10400 : return 
10299 rem---> Displays page
10300 gosub 20350 : qwindow VOIX+1 : gosub 10050 : inverse off : clw 
10305 for X=PAGE(VOIX) to min(PAGE(VOIX)+11,NN(VOIX)) : gosub 10405 : gosub 10500 : next X
10310 return 
10350 gosub 10050 : for X=PAGE(VOIX) to min(PAGE(VOIX)+11,NN(VOIX)) : gosub 10405 : gosub 10500 : next X
10355 if min(PAGE(VOIX)+11,NN(VOIX))=NN(VOIX) then for X=NN(VOIX)+1 to PAGE(VOIX)+11 : gosub 20300 : next X
10360 return 
10399 rem---> Find note name caracteristics
10400 X=CN(VOIX)
10405 Y=TNOTE(VOIX,X) : if Y<0 then 10420
10410 CNOTE=Y mod 256 : if CNOTE<>0 then COCT=(CNOTE-1)/12 : CNOTE=(CNOTE-1) mod 12 else CNOTE=12 : COCT=0
10415 CLONG=Y/256 : LABEL=0 : return 
10420 Y=-Y : LABEL=Y mod 256 : Y=Y/256 : PARAM1=Y mod 256 : Y=Y/256 : PARAM2=Y mod 256 : return 
10499 rem---> Print note number and name
10500 if VOIX=VBLOC and X>=DBLOC and X<=FBLOC then inverse on else inverse off 
10502 if X=CN(VOIX) or X=NN(VOIX) then locate 1,X-PAGE(VOIX) : print using "####:                 ";X+1; : locate 7,X-PAGE(VOIX) : gosub 20300 : gosub 20400 : return 
10505 locate 1,X-PAGE(VOIX) : if LABEL=0 then print using "####: ";X+1; using "~~~~ ";T$(CNOTE);COCT;" ";T$(CLONG+13);space$(23-xcurs); : gosub 20300 : gosub 20200 : return 
10510 gosub 20300 : gosub 20295 : print using "####: ";X+1;T$(23+LABEL); : if LABEL<8 and LABEL<>4 then print space$(23-xcurs); : return 
10512 P=PARAM1 : if LABEL=9 or LABEL=11 then P=P-25
10515 print str$(P); : if LABEL<12 then print space$(23-xcurs); : return 
10520 print ",";PARAM2;space$(23-xcurs); : return 
10599 rem---> Confirn
10600 gosub 20100 : windopen 5,20,10,40,5,0 : scroll off : curs off : locate 0,2 : pen C1 : centre T$(46) : home : paper 0 : pen C3 : square 20,5,1 : locate 20,0 : square 20,5,1
10605 set zone 1,xgraphic(0),ygraphic(0) to xgraphic(20),ygraphic(4)+16/divy : set zone 2,xgraphic(20),ygraphic(0) to xgraphic(39)+8,ygraphic(4)+16/divy
10610 OZ=-1 : repeat : Z=zone(0)-1 : if Z>=0 and Z<2 and Z<>OZ then locate 20*Z,0 : square 20,5,2 : locate 20*(1-Z),0 : square 20,5,1 : OZ=Z
10615 until mouse key : if zone(0)=2 then R=1 else R=0 : bell 
10620 windel 5 : gosub 20150 : reset zone 1 : reset zone 2 : return 
10699 rem---> Draw Enveloppe/tremolo editor screen
10700 inverse off : home : if CENV<25 then centre T$(57)+str$(CENV+1)+" " else centre T$(58)+str$(CENV-24)+" "
10705 for YY=0 to 8 : for XX=0 to 2 : gosub 11100 : next XX : next YY
10710 XX=0 : YY=0 : return 
10799 rem---> Draw ENV/TREM curve
10800 set paint 1,1,0 : ink 0 : bar XGR-8,YGR-16*TGR to XGR+500,YGR
10805 set line $FFFF,1,0,1 : ink 1 : polyline XGR,YGR to XGR,YGR-16*TGR : polyline XGR,YGR to XGR+500,YGR
10810 plot XGR,YGR : N=0 : Y=0 : CV=0 : D=TENV(CENV,N,1) : CN=TENV(CENV,N,2) : V=TENV(CENV,N,0) : if V>100 then return 
10815 for X=0 to 499 step 2 : CV=CV-V : if CV>0 then 10850
10820 CV=CV+100 : Y=Y+D : if Y<0 then Y=0
10825 if Y>15 then Y=15
10830 if CN=0 then 10850
10835 dec CN : if CN>0 then 10850
10840 inc N : if N=9 then 10855
10845 D=TENV(CENV,N,1) : CN=TENV(CENV,N,2) : V=TENV(CENV,N,0) : if V>100 then 10855
10850 draw to XGR+X,YGR-Y*TGR : next X : return 
10855 draw to XGR+X,YGR-Y*TGR : return 
10899 rem---> Plays enveloppe
10900 A$="" : click off : clear key : wait 5 : volume 0 : play 50,0 : Y=0 : N=0 : CV=0 : D=TENV(CENV,N,1) : CN=TENV(CENV,N,2) : V=TENV(CENV,N,0) : if V>100 then 10950
10905 CV=CV-V : if CV>0 then 10935
10910 CV=CV+100 : Y=Y+D : if Y<0 then Y=0
10915 if Y>15 then Y=15
10920 volume Y : if CN=0 then 10935
10922 dec CN : if CN>0 then 10935
10925 inc N : if N=9 then 10950
10930 D=TENV(CENV,N,1) : CN=TENV(CENV,N,2) : V=TENV(CENV,N,0) : CV=0 : if V=128 then 10950 else if V=129 then N=0 : goto 10930
10935 wait 1 : A$=inkey$ : S=scancode : if A$="" then 10905
10950 volume 0 : play 0,0 : click on : return 
10999 rem---> Plays tremolo
11000 A$="" : click off : wait 10 : clear key : volume 15 : psg(7)=%111000 : Y=956 : Y1=Y mod 256 : Y2=Y/256 : for X=0 to 0 step 2 : psg(X)=Y1 : psg(X+1)=Y2 : next X : N=0 : CV=0 : D=TENV(CENV,N,1) : CN=TENV(CENV,N,2) : V=TENV(CENV,N,0) : if V>100 then 11050
11005 CV=CV-V : if CV>0 then 11035
11010 CV=CV+100 : Y=Y-D*14 : if Y<0 then Y=0
11015 if Y>65535 then Y=65535
11020 Y1=Y mod 256 : Y2=Y/256 : for X=0 to 0 step 2 : psg(X)=Y1 : psg(X+1)=Y2 : next X : if CN=0 then 11035
11022 dec CN : if CN>0 then 11035
11025 inc N : if N=9 then 11050
11030 D=TENV(CENV,N,1) : CN=TENV(CENV,N,2) : V=TENV(CENV,N,0) : CV=0 : if V=128 then 10950 else if V=129 then N=0 : goto 11030
11035 wait 1 : A$=inkey$ : S=scancode : if A$="" then 11005
11050 volume 0 : play 0,0 : click on : return 
11099 rem---> Displays SPEED/STEP/NUMBER
11100 locate 20+XX*20,10+YY : X=TENV(CENV,YY,XX) : if XX=0 then if X>=128 then if X=128 then print T$(62); : return else print T$(63); : return 
11105 print X;space$(37+XX*20-xcurs); : return 
11199 rem---> Cleans env/tremolo array
11200 X1=XX : Y1=YY : ZZ=0 : inverse off : for YY=0 to 8 : if ZZ=1 then 11220
11205 if TENV(CENV,YY,0)=0 then TENV(CENV,YY,0)=128 : gosub 11100
11210 if TENV(CENV,YY,0)>100 then ZZ=1 : for XX=1 to 2 : TENV(CENV,YY,XX)=0 : gosub 11100 : next XX
11215 goto 11230
11220 for XX=0 to 2 : if TENV(CENV,YY,XX)<>0 then TENV(CENV,YY,XX)=0 : gosub 11100
11225 next XX
11230 next YY : XX=X1 : YY=Y1 : return 
11299 rem---> Select musics
11300 gosub 20100 : windopen 5,20,2,40,22,5 : curs off : paper C3 : pen 0 : clw : print : centre T$(68)
11305 for X=0 to 1 : for Y=0 to 15 : gosub 11350 : next Y : next X : X=-1
11310 repeat 
11315 X1=-1 : XM=x mouse : if XM>xgraphic(1) and XM<xgraphic(18) then X1=0
11320 if XM>xgraphic(18) and XM<xgraphic(18+18) then X1=1
11325 Y1=(y mouse-ygraphic(3))/(16/divy) : if Y1<0 or Y1>15 then Y1=-1
11330 if X=X1 and Y=Y1 then 11335
11331 inverse off : gosub 11350 : X=X1 : Y=Y1 : inverse on : gosub 11350
11335 until mouse key
11340 if X<0 or Y<0 or (X=1 and Y=15) then R=0 else R=X*16+Y+1
11345 paper 0 : pen C1 : windel 5 : gosub 20150 : return 
11350 if X<0 or Y<0 or (X=1 and Y=15) then return 
11355 N=X*16+Y : if leek(ADB+N*4)<>0 then A$="" : for Z=0 to 7 : A$=A$+chr$(peek(ADB+132+N*8+Z)) : next Z else A$="        "
11360 locate X*18+1,Y+3 : print using " ## : ";N+1;A$;"   "; : return 
11399 rem---> Find start and end address of music
11400 X=leek(ADB+(R-1)*4) : if X=0 then 11425
11405 AD=ADB+X-4 : if X=32 then AF=ADB+LBANK : goto 11420
11410 for X=R+1 to 32 : Y=leek(ADB+(X-1)*4) : if Y<>0 then AF=ADB+Y-4 : goto 11420
11415 next X : AF=ADB+LBANK
11420 LB=AF-AD : return 
11425 for X=R to 32 : Y=leek(ADB+(X-1)*4) : if Y<>0 then AD=ADB+Y-4 : goto 11435
11430 next X : AD=ADB+LBANK
11435 AF=AD : LB=0 : return 
11499 rem---> Input music name
11500 gosub 20100 : windopen 5,10,9,60,7,7
11505 inverse on : clw : locate 0,1 : centre T$(70)
11510 locate 1,3 : print T$(71); : curs on : input NOM$ : if len(NOM$)<8 then NOM$=NOM$+space$(8-len(NOM$))
11515 NOM$=left$(NOM$,8) : for X=1 to 8 : if mid$(NOM$,X,1)=" " then next X : bell : goto 11505
11520 windel 5 : gosub 20150 : return 
11599 rem---> Alarm!
11600 gosub 20100 : windopen 5,10,10,60,7,1 : inverse on : clw 
11605 locate 0,1 : centre T$(T) : locate 0,3 : centre T$(74)
11610 clear key : wait key : windel 5 : gosub 20150 : return 
11700 gosub 20100 : windopen 5,25,10,30,5,10 : curs off : inverse on : clw : locate 0,1 : centre T$(72)
11705 return 
19999 rem---> Erase / draw stave
20000 cls logic,0,XSTAVE,16/divy to 640,176/divy : cls back,0,XSTAVE,16/divy to 640,176/divy
20005 ink C3 : for Y=YSTAVE to YSTAVE-32/divy step-8/divy : draw XSTAVE,Y to 639,Y : draw XSTAVE,Y-48/divy to 639,Y-48/divy : next Y
20010 sprite 1,XSTAVE,YSTAVE-48/divy,1 : update : put sprite 1 : sprite 1,XSTAVE,YSTAVE,2 : update : put sprite 1
20015 return 
20099 rem--> Stave -> string
20100 STAVE$=screen$(back,XSTAVE,16/divy to 640,176/divy) : paper 0 : pen C1 : inverse off : qwindow 1 : qwindow 2 : qwindow 3 : qwindow VOIX+1 : return 
20149 rem--> String -> stave
20150 screen$(back,XSTAVE,16/divy)=STAVE$ : screen$(logic,XSTAVE,16/divy)=STAVE$ : paper 0 : pen C1 : return 
20200 XN=(X-PAGE(VOIX))*32+XSTAVE+48 : YN=OCTY(COCT)+NTEY(CNOTE) : if CNOTE=12 then 20275
20205 SN=NTET(COCT)+NTEL(CLONG)
20210 if YN<-1 then sprite 1,XN,YSTAVE+2*DST,27 : update : put sprite 1 : if YN<-3 then sprite 1,XN,YSTAVE+4*DST,27 : update : put sprite 1
20215 if YN=9 then sprite 1,XN,YSTAVE-10*DST,27 : update : put sprite 1
20220 if YN>20 then for Y=22 to ((YN+1) and $FFFFFFFE) step 2 : sprite 1,XN,YSTAVE-Y*DST,27 : update : put sprite 1 : next Y
20225 sprite 1,XN+4,YSTAVE-YN*DST-1,SN : update : put sprite 1
20230 if NTED(CNOTE) then sprite 1,XN+6,YSTAVE-YN*DST-2,21 : update : put sprite 1
20235 if NTEP(CLONG) then sprite 1,XN+3,YSTAVE-YN*DST-4,22 : update : put sprite 1
20240 if COCT>1 and COCT<7 then return 
20250 if COCT<2 then Y=YSTAVE+5*DST : if COCT then S=23 : goto 20270 else S=24 : goto 20270
20255 Y=YSTAVE-32*DST : S=23
20270 sprite 1,XN-8,Y,S : update : put sprite 1 : return 
20275 sprite 1,XN+4,YSTAVE-7*DST,15+NTEL(CLONG) : update : put sprite 1
20280 sprite 1,XN+4,YSTAVE-19*DST,15+NTEL(CLONG) : update : put sprite 1
20285 if NTEP(CLONG) then sprite 1,XN+3,YSTAVE-7*DST-4,22 : update : put sprite 1 : sprite 1,XN+3,YSTAVE-19*DST-4,22 : update : put sprite 1
20290 sprite off 1 : return 
20295 sprite 1,(X-PAGE(VOIX))*32+XSTAVE+48,YSTAVE-20*DST,28 : update : put sprite 1 : return 
20300 XN=(X-PAGE(VOIX))*32+XSTAVE+48 : screen copy back,608,16/divy,640,176/divy to back,XN,16/divy : screen copy back,608,16/divy,640,176/divy to logic,XN,16/divy : return 
20350 for X=XSTAVE+48 to 600 step 32 : screen copy back,608,16/divy,640,176/divy to back,X,16/divy : screen copy back,608,16/divy,640,176/divy to logic,X,16/divy : next X
20360 return 
20400 if CRS then XN=(X-PAGE(VOIX))*32+XSTAVE+48 : sprite 1,XN+4,YSTAVE-32*DST,26 else sprite off : update 
20405 return 
20499 rem---> Scroll left
20500 screen copy back,XST16+48+32,16/divy,640,YSTAVE+8*DST to back,XST16+48,16/divy
20505 goto 20605
20599 rem---> Scroll right
20600 screen copy back,XST16+48,16/divy,576,176/divy to back,XST16+48+32,16/divy : screen copy back,608,16/divy,640,176/divy to back,XSTAVE+48,16/divy
20605 screen copy back,XST16+48,16/divy,640,176/divy to logic,XST16+48,16/divy
20610 return 
49999 rem---> English menus.
50000 data " STOS "," BANK "," MUSIC "," BLOCK "," TOOLS "
50005 data 4," About MUSIC! ",1,"               ",0," Quit",1," Quit and grab",1
50010 data 7," Load music bank",1," Save music bank",1," Save as ...",1,"                   ",0," Grab from program",1,"                   ",0," Erase music bank",1
50015 data 12," NEW    music",1," RENAME music ",1,"   ",0," PUT    music",1," GET    music",1," APPEND music",1," ERASE  music ",1,"  ",0," PLAY   music",1," PUT and PLAY",1,"  ",0," PRINT  music",1
50020 data 8," Start block",1," End block",1," Cancel block",1,"                 ",0," Copy block",1," Erase block",1,"                 ",0," Transpose block",1
50025 data 3," Fix envelopes",1," Fix tremolos",1," Default env/trem ",1
50099 rem---> Menu Francais
50100 data " STOS "," BANQUE "," MUSIQUE "," BLOC "," OUTILS "
50105 data 4," A propos de MUSIC",1,"                    ",0," Quitter",1," Quitter/r‚cup‚rer",1
50110 data 7," Charger une banque",1," Sauver la banque",1," Sauver comme ...",1,"                    ",0," Copier d'un pgm",1,"                    ",0," Effacer la banque",1
50115 data 12," NOUVELLE musique ",1," RENOMER  musique",1,"  ",0," STOCKER  musique",1," PRENDRE  musique",1," AJOUTER  musique",1," EFFACER  musique",1,"  ",0," JOUER    musique",1," STOCKER et JOUER",1," ",0," IMPRIMER musique",1
50120 data 8," Debut bloc",1," Fin bloc",1," Annuler bloc",1,"                ",0," Copier bloc",1," Effacer bloc",1,"                ",0," Transposer bloc ",1
50125 data 3," Fixer enveloppes ",1," Fixer tr‚molos ",1," Effacer env/trem ",1
50999 rem ---> English messages
51000 data "C","C#","D","D#","E","F","F#","G","G#","A","A#","B","PA","TN","SN","EN","EN.","QN","QN.","HN","HN.","WN","WN.","END","MUSIC","NOISE ONLY","NOISE OFF","NOISE","NTREMOLO OFF","ENVEL OFF","TREMOLO OFF","VOLUME","NTREMOLO","ENVEL","TREMOLO","REPEAT"
51005 data "> Current music <","> Block <","> Under cursor <"
51010 data " Voice"," "," "," ","Voice",","," to","ABANDON            CONFIRM","Grabbing bank from program #1 ","SET TEMPO","Old tempo:"
51015 data "New tempo  ","TRANSPOSE BLOCK","Input number of HALF TONES (-12 to 12)"
51020 data " MUSIC EDITOR "," Part of the Stos basic "," By Francois Lionet "," Copyright 1988 JAWX/MANDARIN "
51025 data " EDITING ENVELOPE NUMBER"," EDITING TREMOLO NUMBER","seconds","S"
51030 data "PHASE   \   SPEED (1-100)   \ STEP (-16 to 16)  \ NUMBER (0-255)"," END            "," LOOP            "
51035 data "F1: previous  - - F2: next - - <ESC> quit - - <SPACE> to hear","<ARROWS> to select phase - - <RETURN> to valid parameter","Type 'END' or 'LOOP' in speed column to end definition.","A 'NUMBER' of zero stands for infinite phase."
51040 data "Please click a music:","Input number (1-64, <RETURN> to quit) ","CURRENT NUSIC NAME","Enter name (8 letters max) "
51045 data "A moment please.","The memory bank is FULL!","Press any key"
51050 data "TOO MANY ENVELOPES OR TREMOLOS!","To get this music, you must first","erase some of the enveloppes or tremolos."
51055 data " Playing: ","<ESC> to quit / <+> & <-> set tempo / </> & <*> set transposition","<S> restarts music / <SPACE>: step by step mode","Once in step by step mode, any other key returns to normal.","Tempo:","Transposition:","Normal","Step by step"
51060 data "         LOAD MUSIC BANK          File name must end with .MBK!","This bank is not a MUSIC bank!","DISK ERROR!","         SAVE MUSIC BANK          File name must end with .MBK!","Music banks present in memory:","Program ",", length:","No music banks in memory!","Enter program number ","Press any key to end...","Printer is not ready!","  Current music : ",""
51100 data "DO","DO#","RE","RE#","MI","FA","FA#","SOL","SOL#","LA","LA#","SI","PA","TC","DC","SC","SC.","NR","NR.","BL","BL.","RD","RD.","FIN","MUSIQUE","BRUIT SEUL","STOP BRUIT","BRUIT","STOP TREM B","STOP ENVEL","STOP TREMOLO","VOLUME","TREM B","ENVEL","TREMOLO","REPETER"
51105 data "> Musique actuelle <","> Bloc <","> Sous le curseur  <"
51110 data " Voix"," "," "," ","Voix",","," ->"," ANNULER            CONFIRMER"," Je copie la banque du programme #1 ","FIXER TEMPO","Ancien tempo:"
51115 data "Nouveau  ","TRANSPOSER LE BLOC","Entrez le nombre de DEMI TONS (-12 a 12)"
51120 data " EDITEUR MUSICAL "," Accessoire du Stos basic "," Par Francois Lionet "," Copyright 1988 JAWX/MANDARIN "
51125 data " EDITION DE L'ENVELOPPE"," EDITION DU TREMOLO","secondes","S"
51130 data "PHASE   \  VITESSE (1-100)  \  PAS (-16 a 16)   \ NOMBRE (0-255)"," FIN             "," BOUCLE          "
51135 data "F1: pr‚c‚dent - - F2: suivant - - <ESC> quitter - - <ESPACE> ‚couter","<FLECHES> pour selectionner la phase - - <RETURN> valide le paramŠtre","Taper 'FIN' ou 'BOUCLE' dans la colonne vitesse pour terminer","Un 'NOMBRE' ‚gal … z‚ro signifie une phase infinie"
51140 data "Cliquez une musique SVP:"," ","NOM DE LA MUSIQUE EDITEE:","Entrez le nom (8 lettres) "
51145 data "Quelques instants SVP.","La banque m‚moire est pleine!","Appuyez sur une touche"
51150 data "TROP D'ENVELOPPES OU DE TREMOLOS!","Pour pouvoir prendre cette musique, effacez","quelques uns des tremolos ou enveloppes!"
51155 data " En train d'ˆtre jou‚: ","ESC pour sortir, + et - rŠglent tempo, / et * rŠglent transposition","S red‚mare la musique, ESPACE passe en mode pas … pas","En mode pas … pas, toute autre touche revient au mode normal","Tempo:","Transposition:","Normal","Pas … pas"
51160 data "  CHARGER UNE BANQUE DE MUSIQUE    Le nom doit finir par .MBK!","Cette banque n'est pas une banque de musique!","Erreur de disque!","   SAUVER LA BANQUE DE MUSIQUE     Le nom doit finir par .MBK!","Banques de musique en m‚moire:","Programme:",", longueur:","La m‚moire ne contient pas de banque de musique !","Entrez le num‚ro du programme ","Presser une touche pour arreter","L'imprimante n'est pas prete!","  Musique editee : ",""
51999 rem---> Default tremolos
52000 data 100,16,1,10,-1,3,5,0,3,10,-1,15,128,0,0
52005 data 100,16,1,50,-1,3,10,-1,3,50,-1,15,128,0,0
52010 data 100,4,4,100,-1,2,5,-1,4,50,-1,14,128,0,0
52015 data 100,2,8,100,-16,1,128,0,0
52020 data 100,2,8,100,-2,8,128,0,0
52025 data 100,16,1,100,-1,5,100,1,5,100,-1,5,100,1,5,100,-1,16,128,0,0
52030 data 100,2,8,100,-2,8,129,0,0
52035 data 100,16,1,50,-1,8,10,0,4,7,-1,8,129,0,0
52040 data-1,0,0
53000 data 100,1,1,100,-1,2,100,1,1,129,0,0
53005 data 50,1,2,50,-1,4,50,1,2,129,0,0
53010 data 100,1,5,100,-1,10,100,1,5,129,0,0
53015 data 100,1,2,100,-1,3,100,1,2,129,0,0
53020 data 100,4,2,100,-4,4,100,4,2,129,0,0
53025 data 50,1,16,128,0,0
53030 data 100,16,1,100,-2,8,128,0,0
53035 data 50,1,8,50,-1,16,50,1,8,129,0,0
53040 data-1,0,0
54997 rem
54998 rem---> Data staves
54999 rem
55000 data 3,3,3,9,3,9,9,9
55001 data 0,1,0,1,0,0,1,0,1,0,1,0
55005 data 0,1,2,2,3,3,4,4,5,5
55010 data 0,0,0,1,0,1,0,1,0,1
55015 data-5,-5,-5,2,9,16,23,23
55020 data 0,0,1,1,2,3,3,4,4,5,5,6
